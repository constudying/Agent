# åˆ¤æ–­æ˜¯å¦æ¥è¿‘Bayesè¯¯å·® - å¿«é€Ÿå‚è€ƒ

## ä»€ä¹ˆæ˜¯Bayesè¯¯å·®ï¼Ÿ

**Bayesè¯¯å·® = æ•°æ®å›ºæœ‰çš„ä¸ç¡®å®šæ€§å¯¼è‡´çš„ç†è®ºæœ€å°æŸå¤±**

å³ä½¿å®Œç¾çš„æ¨¡å‹ä¹Ÿæ— æ³•ä½äºè¿™ä¸ªå€¼ï¼Œå› ä¸ºï¼š

- ä¼ æ„Ÿå™¨å™ªå£°
- äººç±»ç¤ºæ•™çš„éšæœºæ€§  
- ç¯å¢ƒéšæœºæ€§
- å¤šæ¨¡æ€é€‰æ‹©

---

## å¿«é€Ÿåˆ¤æ–­è¡¨

| æ¯”å€¼ (loss/Bayes) | çŠ¶æ€ | å«ä¹‰ | ä¼˜å…ˆè¡ŒåŠ¨ |
|-------------------|------|------|----------|
| < 1.2x | âœ… ä¼˜ç§€ | å·²è¾¾ç†è®ºæé™ | æ”¹è¿›æ•°æ®è´¨é‡ |
| 1.2-1.5x | ğŸŸ¢ è‰¯å¥½ | æ¥è¿‘æé™ | å¾®è°ƒè®­ç»ƒç­–ç•¥ |
| 1.5-2.0x | ğŸŸ¡ ä¸­ç­‰ | æœ‰ä¼˜åŒ–ç©ºé—´ | å¢åŠ è®­ç»ƒ/å®¹é‡ |
| > 2.0x | ğŸ”´ å·® | è¿œæœªè¾¾åˆ° | æ’æŸ¥ä¸¥é‡é—®é¢˜ |

---

## ä¸‰æ­¥å¿«é€Ÿè¯Šæ–­

### Step 1: ä¼°ç®—Bayesè¯¯å·®

**æ–¹æ³•Aï¼šä½¿ç”¨è„šæœ¬ï¼ˆæ¨èï¼‰**

```bash
python agent/scripts/estimate_bayes_error.py \
    --dataset your_data.hdf5 \
    --k 10
```

**æ–¹æ³•Bï¼šæ‰‹åŠ¨è®¡ç®—**

```python
from sklearn.neighbors import NearestNeighbors

# åŠ è½½æ•°æ®
states, actions = load_data()

# æ ‡å‡†åŒ–
states = (states - states.mean(0)) / states.std(0)

# KNN
knn = NearestNeighbors(n_neighbors=10).fit(states)
distances, indices = knn.kneighbors(states)

# è®¡ç®—å±€éƒ¨æ–¹å·®
errors = []
for i in range(len(states)):
    neighbors = actions[indices[i, 1:]]  # æ’é™¤è‡ªå·±
    mean_action = neighbors.mean(0)
    mse = ((neighbors - mean_action) ** 2).mean()
    errors.append(mse)

bayes_error = np.mean(errors)
print(f"Bayesè¯¯å·®: {bayes_error:.6f}")
```

### Step 2: è·å–å½“å‰æŸå¤±

ä»è®­ç»ƒæ—¥å¿—æˆ–TensorBoardï¼š

```python
current_loss = 0.0285  # å»ºè®®ç”¨éªŒè¯é›†æŸå¤±
```

### Step 3: è®¡ç®—æ¯”å€¼å¹¶è¯Šæ–­

**è‡ªåŠ¨è¯Šæ–­ï¼š**

```bash
python quick_diagnosis.py \
    --training_loss 0.0285 \
    --bayes_error 0.0180
```

**æ‰‹åŠ¨åˆ¤æ–­ï¼š**

```python
ratio = current_loss / bayes_error
# 0.0285 / 0.0180 = 1.58x

if ratio < 1.2:
    print("âœ… å·²è¾¾æé™ï¼Œæ”¹è¿›æ•°æ®")
elif ratio < 1.5:
    print("ğŸŸ¢ æ¥è¿‘æé™ï¼Œå¾®è°ƒå‚æ•°")
elif ratio < 2.0:
    print("ğŸŸ¡ æœ‰ç©ºé—´ï¼Œå¢åŠ è®­ç»ƒ")
else:
    print("ğŸ”´ æœ‰é—®é¢˜ï¼Œæ·±å…¥æ’æŸ¥")
```

---

## è¯¦ç»†è¯Šæ–­æŒ‡å—

### æƒ…å†µ1: æ¯”å€¼ < 1.2 ï¼ˆå·²è¾¾æé™ï¼‰âœ…

**ç°çŠ¶ï¼š**

- æ¨¡å‹å·²ç»å¾ˆå¥½
- ç»§ç»­è®­ç»ƒæå‡ < 5%
- æŸå¤±æ¥è¿‘ç†è®ºä¸‹ç•Œ

**ä¸ºä»€ä¹ˆä»»åŠ¡å¯èƒ½ä»ä¸å¥½ï¼Ÿ**

1. **çŠ¶æ€è¡¨ç¤ºä¸å……åˆ†** - ç¼ºå°‘å…³é”®ä¿¡æ¯
2. **Causal confusion** - å­¦åˆ°è™šå‡ç›¸å…³
3. **è®­ç»ƒ-æµ‹è¯•åˆ†å¸ƒä¸åŒ¹é…**
4. **è¯„ä¼°æŒ‡æ ‡ä¸è®­ç»ƒç›®æ ‡ä¸ä¸€è‡´**

**å»ºè®®è¡ŒåŠ¨ï¼š**

```
âœ… åœæ­¢ç»§ç»­è®­ç»ƒï¼ˆæµªè´¹æ—¶é—´ï¼‰
ğŸ” æ£€æŸ¥æ•°æ®è´¨é‡ï¼š
   - çŠ¶æ€æ˜¯å¦åŒ…å«è¶³å¤Ÿä¿¡æ¯ï¼Ÿ
   - æ˜¯å¦éœ€è¦æ—¶åºä¸Šä¸‹æ–‡ï¼Ÿ
   - ä¸“å®¶æ¼”ç¤ºæ˜¯å¦ä¸€è‡´ï¼Ÿ
ğŸ“ˆ æ”¹è¿›æ•°æ®ï¼š
   - å¢åŠ æ•°æ®å¤šæ ·æ€§
   - æé«˜é‡‡é›†è´¨é‡
   - è€ƒè™‘ä¸»åŠ¨å­¦ä¹ 
ğŸ¯ æ£€æŸ¥ä»»åŠ¡è®¾è®¡ï¼š
   - æŸå¤±å‡½æ•°æ˜¯å¦åˆé€‚ï¼Ÿ
   - è¯„ä¼°æŒ‡æ ‡æ˜¯å¦æ­£ç¡®ï¼Ÿ
```

---

### æƒ…å†µ2: æ¯”å€¼ 1.2-1.5 ï¼ˆè‰¯å¥½ï¼‰ğŸŸ¢

**ç°çŠ¶ï¼š**

- æ¥è¿‘ä½†æœªè¾¾æœ€ä¼˜
- è¿˜æœ‰10-25%æå‡ç©ºé—´
- å¤§éƒ¨åˆ†æ½œåŠ›å·²å®ç°

**å»ºè®®è¡ŒåŠ¨ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ï¼š**

```
1. å¾®è°ƒå­¦ä¹ ç‡
   lr = current_lr / 10  # ç”¨æ›´å°çš„å­¦ä¹ ç‡
   
2. å»¶é•¿è®­ç»ƒ
   epochs = current_epochs * 1.5
   
3. å‡å°‘æ­£åˆ™åŒ–
   dropout: 0.1 â†’ 0.05
   weight_decay: 0.01 â†’ 0.001
   
4. å°è¯•å­¦ä¹ ç‡è°ƒåº¦
   - Cosine annealing
   - Warmup + decay
   
5. æ¨¡å‹é›†æˆï¼ˆå¯é€‰ï¼‰
   - è®­ç»ƒå¤šä¸ªæ¨¡å‹
   - é¢„æµ‹æ—¶å–å¹³å‡
```

---

### æƒ…å†µ3: æ¯”å€¼ 1.5-2.0 ï¼ˆä¸­ç­‰ï¼‰ğŸŸ¡

**ç°çŠ¶ï¼š**

- æœ‰æ˜æ˜¾ä¼˜åŒ–ç©ºé—´
- è¿˜æœ‰30-50%æå‡æ½œåŠ›
- æ¨¡å‹å¯èƒ½æ¬ æ‹Ÿåˆ

**å»ºè®®è¡ŒåŠ¨ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ï¼š**

```
1. å¢åŠ è®­ç»ƒè½®æ¬¡
   epochs = current_epochs * 2
   
2. è°ƒæ•´å­¦ä¹ ç‡
   # è¯•è¯•ä¸åŒå€¼
   lr_candidates = [1e-4, 5e-4, 1e-3]
   # ä½¿ç”¨å­¦ä¹ ç‡è°ƒåº¦å™¨
   
3. å¢å¤§æ¨¡å‹å®¹é‡
   hidden_dim: 400 â†’ 512 æˆ– 1024
   transformer_layers: 4 â†’ 6 æˆ– 8
   num_heads: 4 â†’ 8
   
4. å‡å°‘æ­£åˆ™åŒ–
   dropout: 0.1 â†’ 0.05
   
5. æ£€æŸ¥æŸå¤±å‡½æ•°
   # è¿è¡Œå¤šæ¨¡æ€æ£€æµ‹
   python agent/scripts/check_multimodality.py
   # å¦‚æœæœ‰å¤šæ¨¡æ€ï¼Œå¯ç”¨GMM
   "gmm.enabled": true
```

---

### æƒ…å†µ4: æ¯”å€¼ > 2.0 ï¼ˆå·®ï¼‰ğŸ”´

**ç°çŠ¶ï¼š**

- è¿œæœªè¾¾åˆ°ç†è®ºæé™
- æŸå¤±æ˜¯æœ€ä¼˜çš„2å€ä»¥ä¸Š
- å¯èƒ½å­˜åœ¨ä¸¥é‡é—®é¢˜

**æ’æŸ¥æ¸…å•ï¼ˆæŒ‰é¡ºåºï¼‰ï¼š**

#### ç¬¬ä¸€ä¼˜å…ˆçº§ï¼šæ’é™¤Bug âš ï¸

```python
# 1. æ£€æŸ¥æ¢¯åº¦
for name, param in model.named_parameters():
    if param.grad is not None:
        print(f"{name}: {param.grad.norm()}")
# æ¢¯åº¦åº”è¯¥åœ¨ 0.001-10 èŒƒå›´å†…

# 2. ç¡®è®¤æŸå¤±ä¸‹é™
plt.plot(train_losses)
# åº”è¯¥æŒç»­ä¸‹é™ï¼Œä¸åº”è¯¥å¡ä½ä¸åŠ¨

# 3. æ£€æŸ¥æ•°æ®
print("ç¬¬ä¸€ä¸ªbatch:", next(iter(dataloader)))
# ç¡®ä¿æ•°æ®æ­£ç¡®åŠ è½½å’Œå½’ä¸€åŒ–
```

#### ç¬¬äºŒä¼˜å…ˆçº§ï¼šæ£€æŸ¥å¤šæ¨¡æ€æ€§ ğŸ”

```bash
# è¿è¡Œæ£€æµ‹
python agent/scripts/check_multimodality.py --dataset data.hdf5

# å¦‚æœæ£€æµ‹åˆ°å¤šæ¨¡æ€ï¼š
# â†’ MSEæŸå¤±ä¸åˆé€‚ï¼è¿™æ˜¯ä¸»è¦åŸå› 
# â†’ å¯ç”¨GMMæˆ–ä½¿ç”¨Diffusion
```

**å¤šæ¨¡æ€çš„ç—‡çŠ¶ï¼š**

- ç›¸åŒçŠ¶æ€ä¸‹åŠ¨ä½œæ–¹å·®å¾ˆå¤§ (std > 0.5)
- å¯è§†åŒ–æ˜¾ç¤ºå¤šä¸ªèšç±»
- MSEæŸå¤±å¡åœ¨é«˜ä½ä¸é™

**è§£å†³æ–¹æ¡ˆï¼š**

```json
// æ–¹æ¡ˆA: å¯ç”¨GMM
"gmm": {
    "enabled": true,
    "num_modes": 5
}

// æ–¹æ¡ˆB: ä½¿ç”¨Diffusion Policyï¼ˆæ›´å¥½ä½†æ›´æ…¢ï¼‰
```

#### ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼šå¢åŠ æ¨¡å‹å®¹é‡ ğŸ—ï¸

```python
# å½“å‰é…ç½®å¯èƒ½å¤ªå°
{
    "actor_layer_dims": [400, 400],  # â†’ [1024, 1024]
    "transformer": {
        "num_layers": 4,  # â†’ 8
        "num_heads": 4,   # â†’ 8
        "embed_dim": 204  # â†’ 512
    }
}
```

#### ç¬¬å››ä¼˜å…ˆçº§ï¼šæ”¹è¿›è®­ç»ƒ ğŸ”§

```python
1. å­¦ä¹ ç‡
   - è¯•è¯• 1e-4, 5e-4, 1e-3
   - ä½¿ç”¨å­¦ä¹ ç‡finder

2. ä¼˜åŒ–å™¨
   - ä»Adamæ¢åˆ°AdamW
   - è°ƒæ•´weight_decay

3. è®­ç»ƒæ—¶é•¿
   - epochså¯èƒ½éœ€è¦ Ã— 5-10

4. æ‰¹å¤§å°
   - batch_size: 32 â†’ 64 æˆ– 128
   - å¯èƒ½æå‡è®­ç»ƒç¨³å®šæ€§

5. è¾“å…¥ç‰¹å¾
   - æ˜¯å¦åŒ…å«è¶³å¤Ÿä¿¡æ¯ï¼Ÿ
   - å¢åŠ context_length: 1 â†’ 10
```

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆéªŒè¯æŸå¤± > è®­ç»ƒæŸå¤±ï¼Œä½†éƒ½æ¯”Bayesè¯¯å·®é«˜ï¼Ÿ

**A:** è¿™æ˜¯æ­£å¸¸çš„ï¼

- è®­ç»ƒæŸå¤±é€šå¸¸æ›´ä½ï¼ˆæ¨¡å‹è§è¿‡æ•°æ®ï¼‰
- å¦‚æœ `val_loss / train_loss < 1.2`ï¼Œæ²¡æœ‰ä¸¥é‡è¿‡æ‹Ÿåˆ
- å…³æ³¨ `val_loss / bayes_error` çš„æ¯”å€¼

### Q2: æŸå¤±æ¥è¿‘Bayesè¯¯å·®ï¼Œä½†ä»»åŠ¡æˆåŠŸç‡å¾ˆä½ï¼Ÿ

**A:** é—®é¢˜ä¸åœ¨æ¨¡å‹ï¼Œåœ¨äºï¼š

1. **çŠ¶æ€è¡¨ç¤ºä¸å……åˆ†** - ç¼ºå°‘å…³é”®ä¿¡æ¯

   ```python
   # æ£€æŸ¥ï¼šå¢åŠ è§‚æµ‹ç»´åº¦
   # å¢åŠ context_lengthæ•è·æ—¶åºä¿¡æ¯
   ```

2. **Causal confusion** - å­¦åˆ°è™šå‡ç›¸å…³

   ```python
   # è§£å†³ï¼šä½¿ç”¨å¹²é¢„æ•°æ®æˆ–å¯¹æŠ—è®­ç»ƒ
   ```

3. **è®­ç»ƒ-æµ‹è¯•ä¸åŒ¹é…** - åˆ†å¸ƒåç§»

   ```python
   # è§£å†³ï¼šDAggerã€åœ¨çº¿å­¦ä¹ 
   ```

### Q3: ä¸åŒæ–¹æ³•ä¼°ç®—çš„Bayesè¯¯å·®å·®å¼‚å¾ˆå¤§ï¼Ÿ

**A:** æ­£å¸¸ç°è±¡ï¼Œå› ä¸ºå‡è®¾ä¸åŒï¼š

- **KNNæ–¹æ³•** (æ¨è): å‡è®¾å±€éƒ¨å¹³æ»‘
- **èšç±»æ–¹æ³•**: å‡è®¾æ˜ç¡®ç°‡ç»“æ„
- **å™ªå£°æ–¹æ³•**: å‡è®¾æ—¶åºè¿ç»­

**å»ºè®®ï¼š**

- ä»¥KNNæ–¹æ³•ä¸ºå‡†ï¼ˆæœ€ç¨³å¥ï¼‰
- å¦‚æœå·®å¼‚ > 50%ï¼Œæ•°æ®å¯èƒ½æœ‰é—®é¢˜

### Q4: å¦‚ä½•çŸ¥é“æ˜¯æ•°æ®é—®é¢˜è¿˜æ˜¯æ¨¡å‹é—®é¢˜ï¼Ÿ

**å†³ç­–æ ‘ï¼š**

```
loss / bayes_error < 1.2ï¼Ÿ
â”œâ”€ Yes â†’ æ•°æ®é—®é¢˜
â”‚  â”œâ”€ çŠ¶æ€è¡¨ç¤ºä¸å……åˆ†
â”‚  â”œâ”€ æ•°æ®è´¨é‡å·®
â”‚  â””â”€ åˆ†å¸ƒä¸åŒ¹é…
â”‚
â””â”€ No â†’ æ¨¡å‹/è®­ç»ƒé—®é¢˜
   â”œâ”€ loss/bayes > 2x â†’ ä¸¥é‡é—®é¢˜
   â”‚  â”œâ”€ æ£€æŸ¥å¤šæ¨¡æ€æ€§
   â”‚  â”œâ”€ å¢åŠ æ¨¡å‹å®¹é‡
   â”‚  â””â”€ æ’é™¤bug
   â”‚
   â””â”€ 1.5x < loss/bayes < 2x â†’ å¯ä¼˜åŒ–
      â”œâ”€ å¢åŠ è®­ç»ƒ
      â”œâ”€ è°ƒæ•´å­¦ä¹ ç‡
      â””â”€ å‡å°‘æ­£åˆ™åŒ–
```

---

## å·¥å…·ä½¿ç”¨æµç¨‹

### å®Œæ•´è¯Šæ–­æµç¨‹

```bash
# 1. ä¼°ç®—Bayesè¯¯å·®
python agent/scripts/estimate_bayes_error.py \
    --dataset your_data.hdf5 \
    --training_loss 0.0285 \
    --k 10

# è¾“å‡ºï¼š
# Bayesè¯¯å·®: 0.0180
# æ¯”å€¼: 1.58x
# è¯Šæ–­: æœ‰æ˜æ˜¾ä¼˜åŒ–ç©ºé—´

# 2. æ£€æŸ¥å¤šæ¨¡æ€æ€§ï¼ˆå¦‚æœæ¯”å€¼ > 2xï¼‰
python agent/scripts/check_multimodality.py \
    --dataset your_data.hdf5

# 3. å¿«é€Ÿè¯Šæ–­
python quick_diagnosis.py \
    --training_loss 0.0285 \
    --bayes_error 0.0180 \
    --train_loss 0.0265 \
    --val_loss 0.0312
```

### åªæœ‰è®­ç»ƒæŸå¤±ï¼Œå¿«é€Ÿä¼°ç®—

```bash
# å¦‚æœæ²¡æœ‰æ—¶é—´è¿è¡Œå®Œæ•´åˆ†æ
python quick_diagnosis.py \
    --training_loss 0.0285 \
    --action_variance 0.24
    
# ä¼šç”¨åŠ¨ä½œæ–¹å·®ç²—ç•¥ä¼°è®¡Bayesè¯¯å·®
# ç²¾åº¦è¾ƒä½ï¼Œä½†å¯ä»¥å¿«é€Ÿåˆ¤æ–­å¤§è‡´çŠ¶æ€
```

---

## æ€»ç»“

### å…³é”®è¦ç‚¹

1. **Bayesè¯¯å·® = ç†è®ºä¸‹ç•Œ**
   - ç”±æ•°æ®è´¨é‡å†³å®š
   - æ— æ³•ä½äºæ­¤å€¼

2. **åˆ¤æ–­æ ‡å‡†ï¼šæ¯”å€¼**

   ```
   < 1.2x  â†’ æ”¹è¿›æ•°æ®
   1.2-1.5x â†’ å¾®è°ƒè®­ç»ƒ
   1.5-2x  â†’ å¢åŠ è®­ç»ƒ/å®¹é‡
   > 2x    â†’ æ’æŸ¥é—®é¢˜
   ```

3. **æœ€å¸¸è§è¯¯åŒº**
   - âŒ æŸå¤±ä¸é™ â†’ å¢å¤§æ¨¡å‹
   - âœ… æŸå¤±ä¸é™ â†’ å…ˆæ£€æŸ¥æ¯”å€¼

4. **å¤šæ¨¡æ€æ€§æ˜¯å…ƒå‡¶**
   - å¦‚æœ loss/bayes > 2x
   - å…ˆæ£€æŸ¥å¤šæ¨¡æ€æ€§
   - MSE + å¤šæ¨¡æ€ = ç¾éš¾

### è®°ä½è¿™ä¸ªå†³ç­–æ ‘

```
è®­ç»ƒæŸå¤±éš¾ä»¥ä¸‹é™ï¼Ÿ
â”‚
â”œâ”€ è®¡ç®— loss / bayes_error
â”‚
â”œâ”€ < 1.2x
â”‚  â””â”€ âœ… æ¨¡å‹å·²å¥½ï¼Œæ”¹è¿›æ•°æ®
â”‚
â”œâ”€ 1.2-1.5x
â”‚  â””â”€ ğŸŸ¢ æ¥è¿‘æœ€ä¼˜ï¼Œå¾®è°ƒ
â”‚
â”œâ”€ 1.5-2x
â”‚  â””â”€ ğŸŸ¡ æœ‰ç©ºé—´ï¼Œå¢åŠ è®­ç»ƒ
â”‚
â””â”€ > 2x
   â””â”€ ğŸ”´ ä¸¥é‡é—®é¢˜
      â”œâ”€ æ£€æŸ¥å¤šæ¨¡æ€æ€§ï¼ˆç¬¬ä¸€æ­¥ï¼ï¼‰
      â”œâ”€ å¢åŠ æ¨¡å‹å®¹é‡
      â”œâ”€ æ”¹è¿›è®­ç»ƒæ–¹æ³•
      â””â”€ æ’é™¤bug
```

---

## ç›¸å…³æ–‡æ¡£

- å®Œæ•´è¯´æ˜ï¼š`MULTIMODALITY_EXPLAINED.md`
- ä¼°ç®—è„šæœ¬ï¼š`agent/scripts/estimate_bayes_error.py`
- å¤šæ¨¡æ€æ£€æµ‹ï¼š`agent/scripts/check_multimodality.py`
- å¿«é€Ÿè¯Šæ–­ï¼š`quick_diagnosis.py`
