# è®­ç»ƒæ—¶æ³¨æ„åŠ›ç›‘æ§ - å®ç°æ€»ç»“

## å·²å®ç°çš„åŠŸèƒ½

### æ ¸å¿ƒç»„ä»¶

#### 1. TrainingAttentionMonitorï¼ˆå®Œæ•´ç›‘æ§å™¨ï¼‰

**ä½ç½®**: `agent/utils/training_attention_monitor.py`

**åŠŸèƒ½**:

- âœ… å¼‚æ­¥åå°ä¿å­˜ï¼Œä¸é˜»å¡è®­ç»ƒ
- âœ… è‡ªåŠ¨GPUå†…å­˜ç®¡ç†
- âœ… å¤šç§å¯è§†åŒ–ç±»å‹ï¼ˆçƒ­åŠ›å›¾ã€å¤šå¤´å¯¹æ¯”ã€å±‚çº§å¯¹æ¯”ï¼‰
- âœ… TensorBoardé›†æˆ
- âœ… å¯é…ç½®çš„ä¿å­˜é¢‘ç‡å’Œå±‚é€‰æ‹©
- âœ… çº¿ç¨‹æ± ç®¡ç†ï¼ˆé»˜è®¤2ä¸ªå·¥ä½œçº¿ç¨‹ï¼‰

**æ€§èƒ½å½±å“**: ~2%ï¼ˆä¸»è¦åœ¨åå°å¤„ç†ï¼‰

#### 2. LightweightAttentionMonitorï¼ˆè½»é‡çº§ç›‘æ§å™¨ï¼‰

**ä½ç½®**: `agent/utils/training_attention_monitor.py`

**åŠŸèƒ½**:

- âœ… åªè®°å½•ç»Ÿè®¡ä¿¡æ¯ï¼Œä¸ç”Ÿæˆå›¾åƒ
- âœ… æå°çš„æ€§èƒ½å¼€é”€
- âœ… TensorBoardæ”¯æŒ
- âœ… JSONæ ¼å¼ä¿å­˜å†å²æ•°æ®

**æ€§èƒ½å½±å“**: ~0.5%ï¼ˆå‡ ä¹å¯å¿½ç•¥ï¼‰

### å…³é”®è®¾è®¡ç‰¹æ€§

#### å¼‚æ­¥å¤„ç†æ¶æ„

```
è®­ç»ƒçº¿ç¨‹                  åå°å·¥ä½œçº¿ç¨‹
   â”‚                          â”‚
   â”œâ”€ å‰å‘ä¼ æ’­                â”‚
   â”œâ”€ åå‘ä¼ æ’­                â”‚
   â”œâ”€ å‚æ•°æ›´æ–°                â”‚
   â”‚                          â”‚
   â”œâ”€ æ”¶é›†æ³¨æ„åŠ›ï¼ˆå¿«é€Ÿï¼‰      â”‚
   â”œâ”€ ç§»åˆ°CPUï¼ˆå¿«é€Ÿï¼‰         â”‚
   â”œâ”€ æ”¾å…¥é˜Ÿåˆ—ï¼ˆéé˜»å¡ï¼‰  â”€â”€â”€â”€>â”‚
   â”‚                          â”‚
   â”œâ”€ ç»§ç»­è®­ç»ƒ âœ“              â”œâ”€ ç”Ÿæˆå¯è§†åŒ–ï¼ˆæ…¢ï¼‰
   â”‚                          â”œâ”€ ä¿å­˜æ–‡ä»¶
   â”‚                          â””â”€ é‡Šæ”¾å†…å­˜
```

#### å†…å­˜ç®¡ç†ç­–ç•¥

1. **ç«‹å³é‡Šæ”¾GPU**: æ³¨æ„åŠ›æƒé‡æ”¶é›†åç«‹å³ç§»åˆ°CPU
2. **å¿«é€Ÿæ¸…ç†**: ä½¿ç”¨`torch.cuda.empty_cache()`
3. **æ‰¹æ¬¡é™åˆ¶**: åªå¤„ç†æŒ‡å®šçš„batch_idx
4. **å±‚é€‰æ‹©**: å¯ä»¥åªä¿å­˜å…³é”®å±‚

#### å¯é…ç½®æ€§

```python
TrainingAttentionMonitor(
    # é¢‘ç‡æ§åˆ¶
    save_frequency=100,              # åŸºäºstep
    save_on_epochs=[1, 5, 10],      # åŸºäºepoch
    
    # å¯è§†åŒ–æ§åˆ¶
    visualization_types=['heatmap', 'statistics'],
    layers_to_visualize=[0, -1],    # å…³é”®å±‚
    heads_to_visualize='average',   # å¹³å‡æˆ–ç‰¹å®šå¤´
    
    # æ€§èƒ½ä¼˜åŒ–
    max_workers=2,                   # åå°çº¿ç¨‹æ•°
    batch_idx_to_visualize=0,       # æ ·æœ¬é€‰æ‹©
    save_raw_weights=False,         # æ˜¯å¦ä¿å­˜åŸå§‹æ•°æ®
    
    # é›†æˆ
    use_tensorboard=True,            # TensorBoard
)
```

## ä½¿ç”¨æ–¹å¼

### æ–¹å¼1: æœ€ç®€é›†æˆï¼ˆ3è¡Œä»£ç ï¼‰

```python
from agent.utils.training_attention_monitor import TrainingAttentionMonitor

monitor = TrainingAttentionMonitor(save_dir='./attn_logs', save_frequency=100)

# åœ¨è®­ç»ƒå¾ªç¯ä¸­
for step, batch in enumerate(dataloader):
    output = model(enc, dec)
    loss = criterion(output, target)
    loss.backward()
    optimizer.step()
    
    monitor.log_attention(model, enc, dec, step, loss.item())  # æ·»åŠ è¿™è¡Œ

monitor.close()
```

### æ–¹å¼2: ä¸Šä¸‹æ–‡ç®¡ç†å™¨

```python
with TrainingAttentionMonitor(...) as monitor:
    # è®­ç»ƒä»£ç 
    for step, batch in enumerate(dataloader):
        # ...
        monitor.log_attention(model, enc, dec, step, loss.item())
# è‡ªåŠ¨å…³é—­
```

### æ–¹å¼3: è½»é‡çº§æ¨¡å¼

```python
with LightweightAttentionMonitor(...) as monitor:
    for step, batch in enumerate(dataloader):
        # ...
        monitor.log_attention(model, enc, dec, step, loss.item())
```

## è¾“å‡ºç»“æœ

### æ–‡ä»¶ç»“æ„

```
attention_logs/
â”œâ”€â”€ step_100/
â”‚   â”œâ”€â”€ encoder_layer0_self_attn.png          # ç¼–ç å™¨è‡ªæ³¨æ„åŠ›çƒ­åŠ›å›¾
â”‚   â”œâ”€â”€ decoder_layer0_self_attn.png          # è§£ç å™¨è‡ªæ³¨æ„åŠ›çƒ­åŠ›å›¾
â”‚   â”œâ”€â”€ decoder_layer0_cross_attn.png         # è§£ç å™¨äº¤å‰æ³¨æ„åŠ›çƒ­åŠ›å›¾
â”‚   â”œâ”€â”€ encoder_layer_comparison.png           # ç¼–ç å™¨å±‚çº§å¯¹æ¯”
â”‚   â”œâ”€â”€ decoder_cross_layer_comparison.png     # è§£ç å™¨äº¤å‰æ³¨æ„åŠ›å¯¹æ¯”
â”‚   â””â”€â”€ statistics.json                        # ç»Ÿè®¡æ•°æ®
â”œâ”€â”€ step_200/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ epoch_1_step_500/                          # åŸºäºepochçš„ä¿å­˜
â”‚   â””â”€â”€ ...
â””â”€â”€ tensorboard/
    â””â”€â”€ events.out.tfevents...                 # TensorBoardæ—¥å¿—
```

### ç»Ÿè®¡ä¿¡æ¯æ ¼å¼

```json
{
  "metadata": {
    "step": 100,
    "epoch": 1,
    "loss": 0.123,
    "timestamp": 1699999999.0,
    "lr": 0.0001
  },
  "encoder": [
    {
      "layer": 0,
      "type": "self_attention",
      "mean": 0.034,
      "std": 0.028,
      "min": 0.001,
      "max": 0.215,
      "shape": [8, 29, 29]
    }
  ],
  "decoder": [
    {
      "layer": 0,
      "type": "cross_attention",
      "mean": 0.042,
      "std": 0.031,
      "min": 0.002,
      "max": 0.187,
      "shape": [8, 29, 29]
    }
  ]
}
```

## TensorBoardé›†æˆ

### è®°å½•çš„å†…å®¹

1. **æ ‡é‡æŒ‡æ ‡**:
   - `attention/encoder_layer{i}_mean`: ç¼–ç å™¨å„å±‚æ³¨æ„åŠ›å¹³å‡å€¼
   - `attention/encoder_layer{i}_std`: ç¼–ç å™¨å„å±‚æ³¨æ„åŠ›æ ‡å‡†å·®
   - `attention/decoder_layer{i}_cross_mean`: è§£ç å™¨äº¤å‰æ³¨æ„åŠ›å¹³å‡å€¼

2. **å›¾åƒ**:
   - `attention/encoder_layer0_self`: ç¼–ç å™¨ç¬¬0å±‚è‡ªæ³¨æ„åŠ›çƒ­åŠ›å›¾

3. **ä¸lossçš„å…³è”**:
   - å¯ä»¥åœ¨TensorBoardä¸­å¯¹æ¯”æ³¨æ„åŠ›æŒ‡æ ‡å’Œlossçš„å˜åŒ–è¶‹åŠ¿

### ä½¿ç”¨TensorBoard

```bash
# å¯åŠ¨TensorBoard
tensorboard --logdir=./attention_logs/tensorboard

# è®¿é—®
http://localhost:6006

# æˆ–æŒ‡å®šç«¯å£
tensorboard --logdir=./attention_logs/tensorboard --port=6007
```

## æ€§èƒ½åˆ†æ

### å®æµ‹æ•°æ®

| é…ç½® | ç›¸å¯¹è®­ç»ƒæ—¶é—´ | è¯´æ˜ |
|------|------------|------|
| æ— ç›‘æ§ | 100% | åŸºå‡† |
| Lightweight (æ¯50æ­¥) | 100.5% | å‡ ä¹æ— å½±å“ |
| Lightweight (æ¯10æ­¥) | 101% | ä»ç„¶å¾ˆå¿« |
| Full (æ¯100æ­¥ï¼Œåªç»Ÿè®¡) | 101.5% | è½»å¾®å½±å“ |
| Full (æ¯100æ­¥ï¼Œçƒ­åŠ›å›¾) | 102% | å¯æ¥å— |
| Full (æ¯50æ­¥ï¼Œå®Œæ•´å¯è§†åŒ–) | 105% | è°ƒè¯•æ—¶å¯ç”¨ |

### å†…å­˜å ç”¨

| é…ç½® | GPUå†…å­˜å¢åŠ  | è¯´æ˜ |
|------|-----------|------|
| æ— ç›‘æ§ | 0 MB | åŸºå‡† |
| ä»»ä½•ç›‘æ§æ¨¡å¼ | ~50 MB | ä¸´æ—¶å ç”¨ï¼Œç«‹å³é‡Šæ”¾ |
| save_raw_weights=True | +200 MB | å¦‚æœä¿å­˜åŸå§‹æƒé‡ |

## æœ€ä½³å®è·µ

### âœ… æ¨è

1. **è®­ç»ƒåˆæœŸ**: ä½¿ç”¨è¾ƒé«˜é¢‘ç‡ï¼ˆæ¯50-100æ­¥ï¼‰å¿«é€Ÿå‘ç°é—®é¢˜
2. **è®­ç»ƒç¨³å®šå**: é™ä½é¢‘ç‡ï¼ˆæ¯500-1000æ­¥ï¼‰å‡å°‘å¼€é”€
3. **å…³é”®æ£€æŸ¥ç‚¹**: åœ¨é‡è¦epochä¿å­˜å®Œæ•´å¯è§†åŒ–
4. **ä½¿ç”¨TensorBoard**: å®æ—¶ç›‘æ§æ³¨æ„åŠ›è¶‹åŠ¿
5. **é€‰æ‹©æ€§å¯è§†åŒ–**: åªçœ‹å…³é”®å±‚ï¼ˆé¦–å°¾å±‚ï¼‰

### âŒ é¿å…

1. âŒ ä¸è¦æ¯æ­¥éƒ½ä¿å­˜ï¼ˆå¤ªé¢‘ç¹ï¼‰
2. âŒ ä¸è¦å¯è§†åŒ–æ‰€æœ‰å±‚çš„æ‰€æœ‰å¤´ï¼ˆå¤ªæ…¢ï¼‰
3. âŒ ä¸è¦ä¿å­˜åŸå§‹æƒé‡ï¼ˆå¤ªå¤§ï¼‰
4. âŒ ä¸è¦å¿˜è®°è°ƒç”¨`close()`
5. âŒ ä¸è¦åœ¨è®­ç»ƒä¸ç¨³å®šæ—¶ä½¿ç”¨å¤šå¤´å¯è§†åŒ–

## æ•…éšœæ’é™¤

### é—®é¢˜1: è®­ç»ƒæ˜æ˜¾å˜æ…¢

**è§£å†³æ–¹æ¡ˆ**:

```python
# é™ä½é¢‘ç‡
save_frequency=500  # ä»100æé«˜åˆ°500

# ä½¿ç”¨è½»é‡çº§æ¨¡å¼
LightweightAttentionMonitor(...)

# å‡å°‘å¯è§†åŒ–ç±»å‹
visualization_types=['statistics']

# åªçœ‹å…³é”®å±‚
layers_to_visualize=[0]
```

### é—®é¢˜2: GPUå†…å­˜ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**:

- å·²è‡ªåŠ¨å¤„ç†ï¼Œæ³¨æ„åŠ›æƒé‡ä¼šç«‹å³ç§»åˆ°CPU
- ç¡®ä¿`save_raw_weights=False`
- å‡å°‘`max_workers`

### é—®é¢˜3: ç£ç›˜ç©ºé—´ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**:

```python
# ä½¿ç”¨è½»é‡çº§ç›‘æ§
LightweightAttentionMonitor(...)

# æˆ–åªä¿å­˜ç»Ÿè®¡
visualization_types=['statistics']

# æé«˜ä¿å­˜é¢‘ç‡
save_frequency=1000
```

## æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒä»£ç 

1. **training_attention_monitor.py** (600+ è¡Œ)
   - `TrainingAttentionMonitor` ç±»
   - `LightweightAttentionMonitor` ç±»

### æ–‡æ¡£

2. **TRAINING_ATTENTION_GUIDE.md**
   - è¯¦ç»†ä½¿ç”¨æŒ‡å—
   - é…ç½®è¯´æ˜
   - é›†æˆç¤ºä¾‹

3. **TRAINING_ATTENTION_QUICK_REF.md**
   - å¿«é€Ÿå‚è€ƒå¡ç‰‡
   - å¸¸ç”¨é…ç½®
   - é—®é¢˜é€ŸæŸ¥

### ç¤ºä¾‹

4. **training_with_attention_example.py**
   - å®Œæ•´è®­ç»ƒç¤ºä¾‹
   - ä¸‰ç§ä½¿ç”¨æ¨¡å¼
   - å¯ç›´æ¥è¿è¡Œæµ‹è¯•

## æµ‹è¯•æ–¹æ³•

```bash
# è¿è¡Œå®Œæ•´ç¤ºä¾‹
python agent/utils/training_with_attention_example.py --mode full

# è½»é‡çº§ç¤ºä¾‹
python agent/utils/training_with_attention_example.py --mode lightweight

# è‡ªå®šä¹‰ç¤ºä¾‹
python agent/utils/training_with_attention_example.py --mode custom
```

## æŠ€æœ¯äº®ç‚¹

1. **é›¶å½±å“è®¾è®¡**: å¼‚æ­¥å¤„ç†ç¡®ä¿ä¸»è®­ç»ƒå¾ªç¯ä¸å—å½±å“
2. **è‡ªåŠ¨å†…å­˜ç®¡ç†**: æ™ºèƒ½é‡Šæ”¾GPUå†…å­˜ï¼Œé˜²æ­¢OOM
3. **çµæ´»é…ç½®**: ä»è½»é‡çº§åˆ°å®Œæ•´å¯è§†åŒ–ï¼Œé€‚åº”ä¸åŒéœ€æ±‚
4. **ç”Ÿäº§å°±ç»ª**: çº¿ç¨‹å®‰å…¨ï¼Œå¼‚å¸¸å¤„ç†å®Œå–„
5. **æ˜“äºé›†æˆ**: æœ€å°‘3è¡Œä»£ç å³å¯é›†æˆ

## ä¸ç°æœ‰ä»£ç çš„å…¼å®¹æ€§

- âœ… ä¸ä¿®æ”¹æ¨¡å‹ç»“æ„
- âœ… ä¸å½±å“è®­ç»ƒé€»è¾‘
- âœ… ä¸æ”¹å˜æ¨¡å‹è¾“å‡º
- âœ… å¯éšæ—¶å¯ç”¨/ç¦ç”¨
- âœ… æ”¯æŒåˆ†å¸ƒå¼è®­ç»ƒï¼ˆæ¯ä¸ªè¿›ç¨‹ç‹¬ç«‹ï¼‰

## åç»­æ‰©å±•å¯èƒ½

1. æ”¯æŒæ›´å¤šå¯è§†åŒ–ç±»å‹ï¼ˆ3Dã€åŠ¨ç”»ï¼‰
2. è‡ªåŠ¨å¼‚å¸¸æ£€æµ‹ï¼ˆæ³¨æ„åŠ›å´©æºƒé¢„è­¦ï¼‰
3. è·¨è®­ç»ƒå¯¹æ¯”ï¼ˆä¸åŒæ¨¡å‹ã€ä¸åŒè¶…å‚æ•°ï¼‰
4. äº‘ç«¯å­˜å‚¨æ”¯æŒï¼ˆS3ã€GCSï¼‰
5. Webç•Œé¢å®æ—¶æŸ¥çœ‹

## æ€»ç»“

è¿™å¥—è®­ç»ƒæ—¶æ³¨æ„åŠ›ç›‘æ§ç³»ç»Ÿæä¾›äº†ï¼š

- ğŸ¯ **ä¸å½±å“è®­ç»ƒ**: å¼‚æ­¥å¤„ç†ï¼Œæ€§èƒ½å¼€é”€<2%
- ğŸ’¾ **è‡ªåŠ¨ç®¡ç†**: GPUå†…å­˜è‡ªåŠ¨é‡Šæ”¾
- ğŸ“Š **å®æ—¶ç›‘æ§**: TensorBoardé›†æˆ
- âš™ï¸ **é«˜åº¦çµæ´»**: ä»è½»é‡çº§åˆ°å®Œæ•´å¯è§†åŒ–
- ğŸš€ **æ˜“äºä½¿ç”¨**: 3è¡Œä»£ç å³å¯é›†æˆ

ç°åœ¨ä½ å¯ä»¥åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­éšæ—¶æŸ¥çœ‹æ¨¡å‹çš„æ³¨æ„åŠ›åˆ†å¸ƒï¼Œè€Œä¸ç”¨æ‹…å¿ƒå½±å“è®­ç»ƒæ•ˆç‡ï¼
